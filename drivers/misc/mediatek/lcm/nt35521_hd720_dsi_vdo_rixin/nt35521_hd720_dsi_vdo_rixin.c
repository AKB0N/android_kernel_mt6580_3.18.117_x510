#ifndef BUILD_LK
#include <linux/string.h>
#endif

#include "lcm_drv.h"

// ---------------------------------------------------------------------------
//  Local Constants
// ---------------------------------------------------------------------------

#define FRAME_WIDTH                                         (720)
#define FRAME_HEIGHT                                        (1280)

#define REGFLAG_DELAY                                       0xFC
#define REGFLAG_END_OF_TABLE                                0xFD

// ---------------------------------------------------------------------------
//  Local Variables
// ---------------------------------------------------------------------------

static LCM_UTIL_FUNCS lcm_util = {0};

#define SET_RESET_PIN(v) (lcm_util.set_reset_pin((v)))

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

// ---------------------------------------------------------------------------
//  Local Functions
// ---------------------------------------------------------------------------

#define dsi_set_cmdq_V2(cmd, count, ppara, force_update) lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update) lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd) lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums) lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg lcm_util.dsi_read_reg()

struct LCM_setting_table {
    unsigned cmd;
    unsigned char count;
    unsigned char para_list[72];
};

static struct LCM_setting_table lcm_initialization_setting[] = {
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x00}},
    {0xC8, 0x01, {0x00}},
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x01}},
    {0xBC, 0x02, {0x90, 0x00}},
    {0xBD, 0x02, {0x90, 0x00}},
    {0xCA, 0x01, {0x01}},
    {0xC0, 0x01, {0x0C}},
    {0xBE, 0x01, {0x60}},
    {0xB3, 0x02, {0x38, 0x38}},
    {0xB4, 0x02, {0x11, 0x11}},
    {0xB6, 0x02, {0x05, 0x05}},
    {0xB9, 0x02, {0x45, 0x45}},
    {0xBA, 0x02, {0x25, 0x25}},
    {0xC4, 0x02, {0x11, 0x11}},
    {0xCE, 0x01, {0x66}},
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x02}},
    {0xB0, 0x10, {0x00, 0x17, 0x00, 0x53, 0x00, 0x82, 0x00, 0x9F, 0x00, 0xB4, 0x00, 0xD8, 0x00, 0xF3, 0x01, 0x1D}},
    {0xB1, 0x10, {0x01, 0x40, 0x01, 0x78, 0x01, 0xA1, 0x01, 0xE5, 0x02, 0x1C, 0x02, 0x1D, 0x02, 0x4F, 0x02, 0x86}},
    {0xB2, 0x10, {0x02, 0xAA, 0x02, 0xDA, 0x02, 0xF9, 0x03, 0x26, 0x03, 0x3E, 0x03, 0x5E, 0x03, 0x6D, 0x03, 0x6E}},
    {0xB3, 0x04, {0x03, 0xD5, 0x03, 0xE7}},
    {0xB4, 0x10, {0x00, 0x1D, 0x00, 0x4F, 0x00, 0x7E, 0x00, 0x99, 0x00, 0xB1, 0x00, 0xD4, 0x00, 0xF1, 0x01, 0x1C}},
    {0xB5, 0x10, {0x01, 0x3F, 0x01, 0x75, 0x01, 0xA0, 0x01, 0xE3, 0x02, 0x1A, 0x02, 0x1C, 0x02, 0x4F, 0x02, 0x86}},
    {0xB6, 0x10, {0x02, 0xAA, 0x02, 0xDB, 0x02, 0xFD, 0x03, 0x28, 0x03, 0x45, 0x03, 0x6A, 0x03, 0x7B, 0x03, 0xC2}},
    {0xB7, 0x04, {0x03, 0xD3, 0x03, 0xED}},
    {0xB8, 0x10, {0x00, 0x04, 0x00, 0x41, 0x00, 0x6D, 0x00, 0x8A, 0x00, 0xA1, 0x00, 0xC7, 0x00, 0xE5, 0x01, 0x12}},
    {0xB9, 0x10, {0x01, 0x36, 0x01, 0x6E, 0x01, 0x9A, 0x01, 0xE0, 0x02, 0x18, 0x02, 0x19, 0x02, 0x4D, 0x02, 0x85}},
    {0xBA, 0x10, {0x02, 0xA9, 0x02, 0xDC, 0x02, 0xFF, 0x03, 0x2F, 0x03, 0x52, 0x03, 0x95, 0x03, 0xD5, 0x03, 0xF1}},
    {0xBB, 0x04, {0x03, 0xF8, 0x03, 0xFB}},
    {0xBC, 0x10, {0x00, 0x17, 0x00, 0x53, 0x00, 0x82, 0x00, 0x9F, 0x00, 0xB4, 0x00, 0xD8, 0x00, 0xF3, 0x01, 0x1D}},
    {0xBD, 0x10, {0x01, 0x40, 0x01, 0x78, 0x01, 0xA1, 0x01, 0xE5, 0x02, 0x1C, 0x02, 0x1D, 0x02, 0x4F, 0x02, 0x86}},
    {0xBE, 0x10, {0x02, 0xAA, 0x02, 0xDA, 0x02, 0xF9, 0x03, 0x26, 0x03, 0x3E, 0x03, 0x5E, 0x03, 0x6D, 0x03, 0x6E}},
    {0xBF, 0x04, {0x03, 0xD5, 0x03, 0xE7}},
    {0xC0, 0x10, {0x00, 0x1D, 0x00, 0x4F, 0x00, 0x7E, 0x00, 0x99, 0x00, 0xB1, 0x00, 0xD4, 0x00, 0xF1, 0x01, 0x1C}},
    {0xC1, 0x10, {0x01, 0x3F, 0x01, 0x75, 0x01, 0xA0, 0x01, 0xE3, 0x02, 0x1A, 0x02, 0x1C, 0x02, 0x4F, 0x02, 0x86}},
    {0xC2, 0x10, {0x02, 0xAA, 0x02, 0xDB, 0x02, 0xFD, 0x03, 0x28, 0x03, 0x45, 0x03, 0x6A, 0x03, 0x7B, 0x03, 0xC2}},
    {0xC3, 0x04, {0x03, 0xD3, 0x03, 0xED}},
    {0xC4, 0x10, {0x00, 0x04, 0x00, 0x41, 0x00, 0x6D, 0x00, 0x8A, 0x00, 0xA1, 0x00, 0xC7, 0x00, 0xE5, 0x01, 0x12}},
    {0xC5, 0x10, {0x01, 0x36, 0x01, 0x6E, 0x01, 0x9A, 0x01, 0xE0, 0x02, 0x18, 0x02, 0x19, 0x02, 0x4D, 0x02, 0x85}},
    {0xC6, 0x10, {0x02, 0xA9, 0x02, 0xDC, 0x02, 0xFF, 0x03, 0x2F, 0x03, 0x52, 0x03, 0x95, 0x03, 0xD5, 0x03, 0xF1}},
    {0xC7, 0x04, {0x03, 0xF8, 0x03, 0xFB}},
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x06}},
    {0xB0, 0x02, {0x29, 0x2A}},
    {0xB1, 0x02, {0x10, 0x12}},
    {0xB2, 0x02, {0x14, 0x16}},
    {0xB3, 0x02, {0x18, 0x1A}},
    {0xB4, 0x02, {0x02, 0x04}},
    {0xB5, 0x02, {0x34, 0x34}},
    {0xB6, 0x02, {0x34, 0x2E}},
    {0xB7, 0x02, {0x2E, 0x2E}},
    {0xB8, 0x02, {0x34, 0x00}},
    {0xB9, 0x02, {0x34, 0x34}},
    {0xBA, 0x02, {0x34, 0x34}},
    {0xBB, 0x02, {0x01, 0x34}},
    {0xBC, 0x02, {0x2E, 0x2E}},
    {0xBD, 0x02, {0x2E, 0x34}},
    {0xBE, 0x02, {0x34, 0x34}},
    {0xBF, 0x02, {0x05, 0x03}},
    {0xC0, 0x02, {0x1B, 0x19}},
    {0xC1, 0x02, {0x17, 0x15}},
    {0xC2, 0x02, {0x13, 0x11}},
    {0xC3, 0x02, {0x2A, 0x29}},
    {0xE5, 0x02, {0x2E, 0x2E}},
    {0xC4, 0x02, {0x29, 0x2A}},
    {0xC5, 0x02, {0x1B, 0x19}},
    {0xC6, 0x02, {0x17, 0x15}},
    {0xC7, 0x02, {0x13, 0x11}},
    {0xC8, 0x02, {0x01, 0x05}},
    {0xC9, 0x02, {0x34, 0x34}},
    {0xCA, 0x02, {0x34, 0x2E}},
    {0xCB, 0x02, {0x2E, 0x2E}},
    {0xCC, 0x02, {0x34, 0x03}},
    {0xCD, 0x02, {0x34, 0x34}},
    {0xCE, 0x02, {0x34, 0x34}},
    {0xCF, 0x02, {0x02, 0x34}},
    {0xD0, 0x02, {0x2E, 0x2E}},
    {0xD1, 0x02, {0x2E, 0x34}},
    {0xD2, 0x02, {0x34, 0x34}},
    {0xD3, 0x02, {0x04, 0x00}},
    {0xD4, 0x02, {0x10, 0x12}},
    {0xD5, 0x02, {0x14, 0x16}},
    {0xD6, 0x02, {0x18, 0x1A}},
    {0xD7, 0x02, {0x2A, 0x29}},
    {0xE6, 0x02, {0x2E, 0x2E}},
    {0xD8, 0x05, {0x00, 0x00, 0x00, 0x54, 0x00}},
    {0xD9, 0x05, {0x00, 0x15, 0x00, 0x00, 0x00}},
    {0xE7, 0x01, {0x00}},
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x03}},
    {0xB1, 0x02, {0x00, 0x00}},
    {0xB0, 0x02, {0x00, 0x00}},
    {0xB2, 0x05, {0x05, 0x00, 0x00, 0x00, 0x00}},
    {0xB3, 0x05, {0x05, 0x00, 0x00, 0x00, 0x00}},
    {0xB4, 0x05, {0x05, 0x00, 0x00, 0x00, 0x00}},
    {0xB5, 0x05, {0x05, 0x00, 0x17, 0x00, 0x00}},
    {0xB6, 0x05, {0x12, 0x00, 0x19, 0x00, 0x00}},
    {0xB7, 0x05, {0x12, 0x00, 0x19, 0x00, 0x00}},
    {0xB8, 0x05, {0x12, 0x00, 0x19, 0x00, 0x00}},
    {0xB9, 0x05, {0x12, 0x00, 0x19, 0x00, 0x00}},
    {0xBA, 0x05, {0x57, 0x00, 0x00, 0x00, 0x00}},
    {0xBB, 0x05, {0x57, 0x00, 0x00, 0x00, 0x00}},
    {0xBC, 0x05, {0x75, 0x00, 0x1A, 0x00, 0x00}},
    {0xBD, 0x05, {0x53, 0x00, 0x1A, 0x00, 0x00}},
    {0xC0, 0x04, {0x00, 0x34, 0x00, 0x00}},
    {0xC1, 0x04, {0x00, 0x34, 0x00, 0x00}},
    {0xC2, 0x04, {0x00, 0x34, 0x00, 0x00}},
    {0xC3, 0x04, {0x00, 0x34, 0x00, 0x00}},
    {0xC4, 0x01, {0x20}},
    {0xC5, 0x01, {0x00}},
    {0xC6, 0x01, {0x00}},
    {0xC7, 0x01, {0x00}},
    {0xF0, 0x05, {0x55, 0xAA, 0x52, 0x08, 0x05}},
    {0xED, 0x01, {0x30}},
    {0xB0, 0x02, {0x17, 0x06}},
    {0xB8, 0x01, {0x08}},
    {0xBD, 0x05, {0x03, 0x07, 0x00, 0x03, 0x00}},
    {0xB1, 0x02, {0x17, 0x06}},
    {0xB9, 0x01, {0x00}},
    {0xB2, 0x02, {0x00, 0x00}},
    {0xBA, 0x01, {0x00}},
    {0xB3, 0x02, {0x17, 0x06}},
    {0xBB, 0x01, {0x0A}},
    {0xB4, 0x02, {0x17, 0x06}},
    {0xB5, 0x02, {0x17, 0x06}},
    {0xB6, 0x02, {0x14, 0x03}},
    {0xB7, 0x02, {0x00, 0x00}},
    {0xBC, 0x01, {0x02}},
    {0xE5, 0x01, {0x06}},
    {0xE6, 0x01, {0x06}},
    {0xE7, 0x01, {0x00}},
    {0xE8, 0x01, {0x06}},
    {0xE9, 0x01, {0x06}},
    {0xEA, 0x01, {0x06}},
    {0xEB, 0x01, {0x00}},
    {0xEC, 0x01, {0x00}},
    {0xC0, 0x01, {0x07}},
    {0xC1, 0x01, {0x80}},
    {0xC2, 0x01, {0xA4}},
    {0xC3, 0x01, {0x05}},
    {0xC4, 0x01, {0x00}},
    {0xC5, 0x01, {0x02}},
    {0xC6, 0x01, {0x22}},
    {0xC7, 0x01, {0x03}},
    {0xC8, 0x02, {0x05, 0x30}},
    {0xC9, 0x02, {0x01, 0x31}},
    {0xCA, 0x02, {0x03, 0x21}},
    {0xCB, 0x02, {0x01, 0x20}},
    {0xD1, 0x05, {0x00, 0x05, 0x09, 0x07, 0x10}},
    {0xD2, 0x05, {0x10, 0x05, 0x0E, 0x03, 0x10}},
    {0xD3, 0x05, {0x20, 0x00, 0x48, 0x07, 0x10}},
    {0xD4, 0x05, {0x30, 0x00, 0x43, 0x07, 0x10}},
    {0xD0, 0x01, {0x00}},
    {0xCC, 0x03, {0x00, 0x00, 0x3E}},
    {0xCD, 0x03, {0x00, 0x00, 0x3E}},
    {0xCE, 0x03, {0x00, 0x00, 0x02}},
    {0xCF, 0x03, {0x00, 0x00, 0x02}},
    {0x6F, 0x01, {0x11}},
    {0xF3, 0x01, {0x01}},
    {0x35, 0x01, {0x00}},
    {0x62, 0x01, {0x01}},
    {0xFF, 0x04, {0xAA, 0x55, 0x25, 0x01}},
    {0x6F, 0x02, {0x16, 0x00}},
    {0xF7, 0x02, {0x10, 0x00}},
    {0x11, 0x01, {0x00}},
    {REGFLAG_DELAY, 0x78, {0x00}},
    {0x29, 0x01, {0x00}},
    {REGFLAG_DELAY, 0x32, {0x00}},
    {REGFLAG_END_OF_TABLE, 0x00, {0x00}}
};

static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
    unsigned int i;

    for (i = 0; i < count; i++)
    {

        unsigned cmd;
        cmd = table[i].cmd;

        switch (cmd)
        {

        case REGFLAG_DELAY:
            MDELAY(table[i].count);
            break;

        case REGFLAG_END_OF_TABLE:
            break;

        default:
            dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
        }
    }
}

// ---------------------------------------------------------------------------
//  LCM Driver Implementations
// ---------------------------------------------------------------------------
static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}

static void lcm_get_params(LCM_PARAMS *params)
{
    memset(params, 0, sizeof(LCM_PARAMS));

    params->type    = LCM_TYPE_DSI;
    params->width   = FRAME_WIDTH;
    params->height  = FRAME_HEIGHT;

    params->dsi.LANE_NUM = LCM_THREE_LANE;
    params->dsi.packet_size = 256;
    params->dsi.word_count = 2160;
    params->dsi.horizontal_sync_active = 4;
    params->dsi.lcm_esd_check_table[0].cmd = 10;
    params->dsi.lcm_esd_check_table[0].para_list[0] = -100;
    params->dsi.PLL_CLOCK = 239;

    params->dsi.PS = LCM_PACKED_PS_24BIT_RGB888;
    params->dsi.vertical_sync_active = 2;

    params->dsi.horizontal_active_pixel = FRAME_WIDTH;
    params->dsi.vertical_active_line    = FRAME_HEIGHT;
    params->dbi.te_mode                 = LCM_DBI_TE_MODE_DISABLED;

    //The following defined the format for data coming from LCD engine.
    params->dsi.data_format.color_order = LCM_COLOR_ORDER_RGB;
    params->dsi.data_format.trans_seq   = LCM_DSI_TRANS_SEQ_MSB_FIRST;
    params->dsi.data_format.padding     = LCM_DSI_PADDING_ON_LSB;
    params->dsi.data_format.format      = LCM_DSI_FORMAT_RGB888;

    params->dsi.mode = SYNC_PULSE_VDO_MODE;

    params->dsi.intermediat_buffer_num = 0;
    params->dsi.esd_check_enable = 1;
    params->dsi.customization_esd_check_enable = 1;
    params->dsi.lcm_esd_check_table[0].count = 1;
    params->dsi.ssc_disable = 1;
    params->dsi.compatibility_for_nvk = 1;

    params->dsi.vertical_backporch      = 20;
    params->dsi.vertical_frontporch     = 20;
    params->dsi.horizontal_backporch    = 40;
    params->dsi.horizontal_frontporch   = 40;
}

static void lcm_init(void)
{
    SET_RESET_PIN(1);
    SET_RESET_PIN(0);
    MDELAY(50);
    SET_RESET_PIN(1);
    MDELAY(120);

    push_table(lcm_initialization_setting, sizeof(lcm_initialization_setting) / sizeof(struct LCM_setting_table), 1);
}

static void lcm_suspend(void)
{
    SET_RESET_PIN(0);
    MDELAY(120);
}

static void lcm_resume(void)
{
    lcm_init();
}

static unsigned int lcm_compare_id(void)
{
    return 1; // хак, работает только если компилировать с одным LCM, но если охота поддерживать несколько ревезий или телефонов в одном ядре - пиши, поправлю
}

LCM_DRIVER nt35521_hd720_dsi_vdo_rixin_lcm_drv = {
        .name = "nt35521_hd720_dsi_vdo_rixin",
        .set_util_funcs = lcm_set_util_funcs,
        .get_params = lcm_get_params,
        .init = lcm_init,
        .compare_id = lcm_compare_id,
        .suspend = lcm_suspend,
        .resume = lcm_resume,
};

